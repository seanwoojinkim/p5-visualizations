<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Tracking Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 14px;
            cursor: pointer;
        }
        .output {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Session Tracking Test</h1>
    <p>This page tests the session tracking functionality without requiring the full coherence visualization.</p>

    <div>
        <button onclick="testDatabase()">Test Database</button>
        <button onclick="testStatistics()">Test Statistics</button>
        <button onclick="testSessionRecorder()">Test Session Recorder</button>
        <button onclick="testFullWorkflow()">Test Full Workflow</button>
        <button onclick="clearDatabase()">Clear Database</button>
    </div>

    <div id="output" class="output"></div>

    <script type="module">
        import { HRVDatabase } from './src/session/hrv-database.js';
        import { SessionRecorder } from './src/session/session-recorder.js';
        import { mean, median, calculateTimeInZones, formatDuration } from './src/utils/statistics.js';

        window.log = function(message, isError = false) {
            const output = document.getElementById('output');
            const className = isError ? 'error' : 'success';
            output.innerHTML += `<span class="${className}">${message}</span>\n`;
            console.log(message);
        };

        window.testDatabase = async function() {
            window.log('=== Testing HRVDatabase ===');
            try {
                const db = new HRVDatabase();
                await db.init();
                window.log('✓ Database initialized');

                // Create a test session
                const sessionId = await db.createSession();
                window.log(`✓ Created session: ${sessionId}`);

                // Add test samples
                const samples = [];
                for (let i = 0; i < 10; i++) {
                    samples.push({
                        coherence: 50 + Math.random() * 30,
                        ratio: 3 + Math.random() * 4,
                        peakFrequency: 0.08 + Math.random() * 0.04,
                        heartRate: 60 + Math.random() * 20,
                        level: -1 + Math.random() * 2
                    });
                }
                await db.addSamples(sessionId, samples);
                window.log(`✓ Added ${samples.length} samples`);

                // Get samples back
                const retrievedSamples = await db.getSamples(sessionId);
                window.log(`✓ Retrieved ${retrievedSamples.length} samples`);

                // End session
                const session = await db.endSession(sessionId);
                window.log(`✓ Session ended. Mean coherence: ${session.meanCoherence.toFixed(1)}`);

                db.close();
            } catch (error) {
                window.log(`✗ Error: ${error.message}`, true);
            }
        };

        window.testStatistics = function() {
            window.log('=== Testing Statistics ===');
            const values = [45, 67, 52, 89, 34, 78, 61];
            window.log(`Values: ${values.join(', ')}`);
            window.log(`Mean: ${mean(values).toFixed(2)}`);
            window.log(`Median: ${median(values).toFixed(2)}`);

            const samples = values.map(v => ({ coherence: v }));
            const zones = calculateTimeInZones(samples);
            window.log(`Time in zones: Low=${zones.low.percentage.toFixed(0)}%, Med=${zones.medium.percentage.toFixed(0)}%, High=${zones.high.percentage.toFixed(0)}%`);
            window.log(`Duration format: ${formatDuration(245)}`);
        };

        window.testSessionRecorder = async function() {
            window.log('=== Testing SessionRecorder ===');
            try {
                const recorder = new SessionRecorder();
                await recorder.init();
                window.log('✓ SessionRecorder initialized');

                // Start recording
                const sessionId = await recorder.startRecording();
                window.log(`✓ Recording started: ${sessionId}`);

                // Add some samples
                for (let i = 0; i < 5; i++) {
                    recorder.addSample({
                        coherence: 50 + Math.random() * 30,
                        ratio: 3 + Math.random() * 4,
                        peakFrequency: 0.08 + Math.random() * 0.04,
                        heartRate: 60 + Math.random() * 20,
                        level: -1 + Math.random() * 2
                    });
                }
                window.log(`✓ Added 5 samples`);

                // Stop recording
                const session = await recorder.stopRecording();
                window.log(`✓ Recording stopped`);
                window.log(`  Duration: ${formatDuration(session.durationSeconds)}`);
                window.log(`  Mean coherence: ${session.meanCoherence.toFixed(1)}/100`);
                window.log(`  Samples: ${session.samplesCollected}`);

                recorder.destroy();
            } catch (error) {
                window.log(`✗ Error: ${error.message}`, true);
            }
        };

        window.testFullWorkflow = async function() {
            window.log('=== Testing Full Workflow ===');
            try {
                const recorder = new SessionRecorder();
                await recorder.init();

                // Simulate recording a session
                await recorder.startRecording();
                window.log('✓ Started recording');

                // Simulate coherence updates over time
                const numSamples = 20;
                for (let i = 0; i < numSamples; i++) {
                    const coherence = 40 + Math.random() * 40 + Math.sin(i / 5) * 20; // Varying coherence
                    recorder.addSample({
                        coherence: coherence,
                        ratio: coherence / 15,
                        peakFrequency: 0.1,
                        heartRate: 70,
                        level: (coherence - 50) / 50
                    });
                }
                window.log(`✓ Added ${numSamples} samples`);

                // Stop and get summary
                const session = await recorder.stopRecording();
                window.log(`✓ Session complete!`);
                window.log(`  Session ID: ${session.sessionId}`);
                window.log(`  Duration: ${formatDuration(session.durationSeconds)}`);
                window.log(`  Mean coherence: ${session.meanCoherence.toFixed(1)}/100`);
                window.log(`  Max coherence: ${session.maxCoherence.toFixed(1)}/100`);
                window.log(`  High zone time: ${Math.round(session.timeInZones.high.seconds / 60)}m (${session.timeInZones.high.percentage.toFixed(0)}%)`);
                window.log(`  Achievement score: ${session.achievementScore}`);

                // Verify in database
                const recentSessions = await recorder.getRecentSessions(5);
                window.log(`✓ Found ${recentSessions.length} recent session(s) in database`);

                recorder.destroy();
            } catch (error) {
                window.log(`✗ Error: ${error.message}`, true);
                console.error(error);
            }
        };

        window.clearDatabase = async function() {
            if (!confirm('Are you sure you want to clear all sessions?')) return;

            window.log('=== Clearing Database ===');
            try {
                const db = new HRVDatabase();
                await db.init();

                const sessions = await db.getAllSessions();
                for (const session of sessions) {
                    await db.deleteSession(session.sessionId);
                }

                window.log(`✓ Deleted ${sessions.length} session(s)`);
                db.close();
            } catch (error) {
                window.log(`✗ Error: ${error.message}`, true);
            }
        };

        // Auto-run basic test on load
        window.addEventListener('load', () => {
            window.log('Page loaded. Click buttons to run tests.');
        });
    </script>
</body>
</html>
